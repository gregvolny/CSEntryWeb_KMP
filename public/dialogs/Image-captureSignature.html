<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <link rel="stylesheet" href="/css/dialogs.css">

    <!-- Unified Action invoker - auto-detects environment -->
    <script src="../action-invoker.js"></script>

    <title>CSPro Signature Capture</title>
</head>
<body>
    <p id="message" style="visibility: hidden"></p>
    <p><img id="signature" /></p>

    <p><a href="#" onclick="saveSignature(); return false;">Save</a> - <a href="#" onclick="clearSignature(); return false;">Clear</a></p>

    <script>
        const message = document.getElementById("message");
        const signature = document.getElementById("signature");
        
        // Create global CS instance - unified action-invoker handles environment detection
        const CS = new CSProActionInvoker('');
        
        // Signal ready to parent (for web mode iframe dialogs)
        if (CSProEnvironment.isWebMode() && window.parent !== window) {
            window.parent.postMessage({ type: 'cspro-dialog-ready' }, '*');
            console.log('[Image-captureSignature] Sent cspro-dialog-ready to parent');
            
            // Listen for initialization message from parent via cspro-input-ready event
            window.addEventListener('cspro-input-ready', (event) => {
                console.log('[Image-captureSignature] Received cspro-input-ready:', event.detail);
                initializeSignatureDialog();
            });
            
            // Check if already initialized
            if (typeof CSProActionInvokerWebState !== 'undefined' && CSProActionInvokerWebState.initialized) {
                initializeSignatureDialog();
            }
        } else {
            // Native mode - initialize immediately
            initializeSignatureDialog();
        }
        
        function initializeSignatureDialog() {
            const input = CS.UI.getInputData();
            console.log('[Image-captureSignature] Input data:', input);

            // size the dialog at half the screen
            const dimensions = CS.UI.getMaxDisplayDimensions();
            CS.UI.setDisplayOptions({
                width: dimensions.width / 2,
                height: dimensions.height / 2,
                keyboard: false
            });

            // if set, display the message
            if( input.message ) {
                message.innerText = input.message;
                message.style.visibility = "visible";
            }

            // if a signature already exists, show it
            if( input.url ) {
                signature.src = input.url;
            }
        }

        function saveSignature() {
            // TODO ... make sure not blank
            // https://stackoverflow.com/questions/934012/get-image-data-url-in-javascript
            const canvas = document.createElement("canvas");
            canvas.width = signature.width;
            canvas.height = signature.height;

             // Copy the image contents to the canvas
            const ctx = canvas.getContext("2d");
            ctx.drawImage(signature, 0, 0);

            CS.UI.closeDialog({ result: { url: canvas.toDataURL() } });
        }

        function clearSignature() {
            signature.removeAttribute("src");
        }
    </script>
</body>
</html>
